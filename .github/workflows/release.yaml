name: Example Pipeline

on:
  push:
    branches:
      - main
      - '**/feature/**'
  pull_request:
    branches:
      - main
      - '**/feature/**'

jobs:
  build-and-sbom:
    name: Build and Generate SBOM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Syft
        run: |
          echo "Installing Syft..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Verify Syft installation
        run: |
          syft version

      - name: Build project and generate SBOM
        run: |
          echo "Building the project..."
          mkdir -p ./build  # Ensure build directory exists

          # Add your build commands here, for example:
          # python setup.py build

          echo "Generating SBOM..."
          syft ./build -o sbom.sbom --format syft-json  # Generate SBOM in syft-json format

          echo "metadata_build=true" >> $GITHUB_ENV  # Set build metadata to true

      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: sbom
          path: sbom.sbom

      - name: Set metadata.build to true
        run: |
          echo "Setting metadata.build to true..."
          echo "metadata_build=true" >> $GITHUB_ENV  # Ensure the environment variable is set
        env:
          METADATA_BUILD: true

    environment: development

    permissions:
      contents: read
      issues: write

    concurrency:
      group: example-group
      cancel-in-progress: true
